{% extends "base.html" %}

{% block header %}
  <script type="text/javascript">
    var selectedBoxDefinitionId = 0;

    function loadBoxDefinitions() {
      $("#boxDefinitionList").empty();
      Service.invoke("GET", "boxx", {}, function(results) {
        for (var i = 0, len=results.data.length; i < len; ++i) {
          $("#boxDefinitionList").append(renderBoxDefinition(results.data[i]));
        }
      });
    }

    function renderBoxDefinition(data) {
      return $("<a href='#'>").click(function(e) {
        e.preventDefault();
        boxListingClicked(data.id);
      }).append($("<li>").text(data.name));
    }

    function boxListingClicked(id) {
      Service.invoke("GET", "boxx/" + id, {}, function(results) {
        selectedBoxDefinitionId = id;
        $("#boxDefinitionOutput").val(JSON.stringify(results.data, null, 2))
      });
    }

    function peekClicked(take) {
      Service.invoke("POST",
        "boxx/" + selectedBoxDefinitionId + (take ? "/take" : "/peek"),
        JSON.stringify({
          user_token: $("#userTokenInput").val(),
          series_token: $("#seriesTokenInput").val()
        }),
        function(results) {
          $("#actionOutput").val(JSON.stringify(results.data, null, 2))
        }
      );
    }

    function clearAll() {
      $("#boxDefinitionList").empty();
      $("#boxDefinitionOutput").val("")
      $("#actionOutput").val("")
    }

    Service.addApiKeyListener(function(e) {
      if (e.apiKey) {
        clearAll();
        loadBoxDefinitions();
        $(".mainStuff").show();
      }
      else {
        $(".mainStuff").hide();
      }
    });
  </script>
  <style>
    li {
      display: inline-block;
      margin: 0px 10px;
    }
  </style>
{% endblock header %}

{% block content %}
<div>
  <h2>Box Admin</h2>
  <p><span class="apiKeyWidget"></span><p>
  <p class="serviceErrorContainer serviceErrorText error"></p>
  <div class="mainStuff" style="display: none;">
    <p>Select a box from the list below. (If empty, go to the <a href="forge">forge</a> to create one.)</p>
    <h3>Box definitions</h3>
    <p id="boxDefinitionList"></p>
    <table><tbody>
    <tr>
      <td><h4>Box Definition Details</h4></td>
      <td><h4>Actions</h4></td>
      <td><h4>Results</h4></td>
    </tr>
    <tr>
      <td valign="top">
        <textarea id="boxDefinitionOutput" readonly=readonly rows="30" cols="40">
        </textarea>
      </td>
      <td valign="top">
        Specify a user token (required):<br/>
        <input id="userTokenInput" type="text" style="width: 200px"><br/>
        Specify a series token (optional):<br/>
        <input id="seriesTokenInput" type="text" style="width: 200px"><br/>
        <button type="button" onclick="peekClicked(false)">Peek</button>
        <button type="button" onclick="peekClicked(true)">Take</button>
      </td>
      <td valign="top">
        <textarea id="actionOutput" readonly=readonly rows="30" cols="40">
        </textarea>
      </td>
    </tr></tbody></table>
  </div>
</div>
{% endblock content %}
